image: laravelsail/php82-composer

stages:
  - setup
  - test
  - deploy

variables:
  MYSQL_DATABASE: onlinestore_test
  MYSQL_ROOT_PASSWORD: root
  DB_CONNECTION: mysql
  DB_HOST: mysql
  DB_PORT: 3306
  DB_DATABASE: $MYSQL_DATABASE
  DB_USERNAME: root
  DB_PASSWORD: root
  APP_ENV: testing

services:
  - mysql:8.0

cache:
  paths:
    - vendor/
    - node_modules/

before_script:
  - cp .env.example .env
  - composer install --prefer-dist --no-progress --no-suggest
  - php artisan key:generate
  - php artisan migrate --force

setup:
  stage: setup
  script:
    - echo "âœ… Setup stage completed."

test:
  stage: test
  script:
    - php artisan test
  artifacts:
    when: always
    paths:
      - storage/logs
    expire_in: 1 week

deploy:
  stage: deploy
  only:
    - main
  script:
    - echo "ðŸš€ Deploy stage (manual setup required)."
